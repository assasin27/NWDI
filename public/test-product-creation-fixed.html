<!DOCTYPE html>
<html>
<head>
  <title>Test Product Creation (Fixed)</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
    .card { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    input, button { 
      display: block; 
      width: 100%; 
      padding: 10px; 
      margin: 10px 0; 
      box-sizing: border-box;
    }
    button { 
      background: #4CAF50; 
      color: white; 
      border: none; 
      cursor: pointer; 
      font-weight: bold;
    }
    button:disabled { background: #cccccc; cursor: not-allowed; }
    #result { 
      margin: 20px 0; 
      padding: 15px; 
      border-radius: 4px; 
      white-space: pre-wrap;
      font-family: monospace;
      min-height: 50px;
    }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
  </style>
</head>
<body>
  <h1>Test Product Creation</h1>
  
  <div class="card" id="configSection">
    <h2>1. Configure Supabase</h2>
    <p>Enter your Supabase credentials (get these from Project Settings → API in Supabase)</p>
    
    <label for="supabaseUrl">Supabase URL:</label>
    <input type="text" id="supabaseUrl" placeholder="https://xxxxxxxxxxxxx.supabase.co" />
    
    <label for="supabaseKey">Anon/Public Key:</label>
    <input type="text" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." />
    
    <button id="saveConfig">Save Configuration</button>
  </div>
  
  <div class="card" id="authSection" style="display: none;">
    <h2>2. Sign In</h2>
    <div id="authStatus">Not signed in</div>
    <button id="signIn">Sign In with Email</button>
    <button id="signOut" disabled>Sign Out</button>
  </div>
  
  <div class="card" id="productSection" style="display: none;">
    <h2>3. Test Product Creation</h2>
    <p>Create a test product to verify everything is working:</p>
    <button id="testProduct">Create Test Product</button>
    <div id="testResult"></div>
  </div>
  
  <div class="card" id="productsListSection" style="display: none;">
    <h2>Your Products</h2>
    <button id="listProducts">Refresh Product List</button>
    <div id="productsList"></div>
  </div>
  
  <div id="result"></div>

  <script>
    // DOM Elements
    const configSection = document.getElementById('configSection');
    const authSection = document.getElementById('authSection');
    const productSection = document.getElementById('productSection');
    const productsListSection = document.getElementById('productsListSection');
    const signInBtn = document.getElementById('signIn');
    const signOutBtn = document.getElementById('signOut');
    const testProductBtn = document.getElementById('testProduct');
    const listProductsBtn = document.getElementById('listProducts');
    const testResult = document.getElementById('testResult');
    const productsList = document.getElementById('productsList');
    const resultDiv = document.getElementById('result');
    const authStatus = document.getElementById('authStatus');
    
    let supabase;
    
    // Load saved config
    function loadConfig() {
      const savedUrl = localStorage.getItem('supabaseUrl');
      const savedKey = localStorage.getItem('supabaseKey');
      
      if (savedUrl && savedKey) {
        document.getElementById('supabaseUrl').value = savedUrl;
        document.getElementById('supabaseKey').value = savedKey;
        initSupabase(savedUrl, savedKey);
      }
    }
    
    // Initialize Supabase client
    function initSupabase(url, key) {
      try {
        supabase = window.supabase.createClient(url, key);
        checkAuth();
        return true;
      } catch (error) {
        showResult(`Error initializing Supabase: ${error.message}`, true);
        return false;
      }
    }
    
    // Save configuration
    document.getElementById('saveConfig').addEventListener('click', () => {
      const url = document.getElementById('supabaseUrl').value.trim();
      const key = document.getElementById('supabaseKey').value.trim();
      
      if (!url || !key) {
        showResult('Please enter both URL and Key', true);
        return;
      }
      
      localStorage.setItem('supabaseUrl', url);
      localStorage.setItem('supabaseKey', key);
      
      if (initSupabase(url, key)) {
        showResult('Configuration saved successfully!', false);
        configSection.style.display = 'none';
        authSection.style.display = 'block';
      }
    });
    
    // Check authentication status
    async function checkAuth() {
      if (!supabase) return;
      
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) throw error;
        
        if (session) {
          authStatus.innerHTML = `
            <div class="success">
              Signed in as: <strong>${session.user.email}</strong><br>
              User ID: <code>${session.user.id}</code>
            </div>
          `;
          signInBtn.disabled = true;
          signOutBtn.disabled = false;
          productSection.style.display = 'block';
          productsListSection.style.display = 'block';
          listProducts();
        } else {
          authStatus.innerHTML = '<div class="info">Not signed in</div>';
          signInBtn.disabled = false;
          signOutBtn.disabled = true;
          productSection.style.display = 'none';
          productsListSection.style.display = 'none';
        }
        
        return session;
      } catch (error) {
        console.error('Auth check error:', error);
        showResult(`Error checking auth status: ${error.message}`, true);
        return null;
      }
    }
    
    // Sign in with email
    signInBtn.addEventListener('click', async () => {
      const email = prompt('Enter your email:');
      if (!email) return;
      
      try {
        showResult('Sending sign-in link to your email...', false);
        
        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: {
            emailRedirectTo: window.location.href,
            shouldCreateUser: true
          }
        });
        
        if (error) throw error;
        
        showResult('Check your email for the sign-in link! Click it to complete authentication.', false);
        
        // Poll for session after a short delay
        const checkSession = setInterval(async () => {
          const session = await checkAuth();
          if (session) {
            clearInterval(checkSession);
            showResult('Successfully authenticated! You can now create test products.', false);
          }
        }, 2000);
        
      } catch (error) {
        console.error('Sign in error:', error);
        showResult(`Error signing in: ${error.message}`, true);
      }
    });
    
    // Sign out
    signOutBtn.addEventListener('click', async () => {
      try {
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
        showResult('Signed out successfully', false);
        checkAuth();
      } catch (error) {
        showResult(`Error signing out: ${error.message}`, true);
      }
    });
    
    // Create test product
    testProductBtn.addEventListener('click', async () => {
      testProductBtn.disabled = true;
      testProductBtn.textContent = 'Creating test product...';
      
      try {
        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) throw new Error('Not authenticated');
        
        // Get or create seller profile
        let { data: sellerProfile, error: sellerError } = await supabase
          .from('seller_profiles')
          .select('id')
          .eq('user_id', user.id)
          .single();
          
        // Create seller profile if it doesn't exist
        if (!sellerProfile || sellerError) {
          const { data: newProfile, error: createError } = await supabase
            .from('seller_profiles')
            .insert([{ 
              user_id: user.id,
              business_name: 'Test Seller ' + Math.random().toString(36).substring(2, 8),
              created_at: new Date().toISOString()
            }])
            .select()
            .single();
            
          if (createError) throw createError;
          sellerProfile = newProfile;
        }
        
        // Create test product
        const testProduct = {
          name: `Test Product ${new Date().toISOString()}`,
          description: 'This is a test product',
          price: 999, // $9.99 in cents
          category_id: await getOrCreateTestCategory(),
          stock_quantity: 10,
          seller_id: sellerProfile.id,
          image_url: 'https://source.unsplash.com/400x300/?product,test',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };
        
        const { data: product, error: productError } = await supabase
          .from('products')
          .insert([testProduct])
          .select()
          .single();
          
        if (productError) throw productError;
        
        showResult(`✅ Test product created successfully!\nID: ${product.id}\nName: ${product.name}`, false);
        
        // Refresh products list
        listProducts();
        
      } catch (error) {
        console.error('Error creating test product:', error);
        showResult(`❌ Error: ${error.message}`, true);
      } finally {
        testProductBtn.disabled = false;
        testProductBtn.textContent = 'Create Test Product';
      }
    });
    
    // List products
    listProductsBtn.addEventListener('click', listProducts);
    
    async function listProducts() {
      listProductsBtn.disabled = true;
      listProductsBtn.textContent = 'Loading...';
      
      try {
        const { data: products, error } = await supabase
          .from('products')
          .select('*')
          .order('created_at', { ascending: false });
          
        if (error) throw error;
        
        if (products && products.length > 0) {
          productsList.innerHTML = `
            <h3>Your Products (${products.length})</h3>
            <pre>${JSON.stringify(products, null, 2)}</pre>
          `;
        } else {
          productsList.innerHTML = '<p>No products found.</p>';
        }
      } catch (error) {
        productsList.innerHTML = `<div class="error">Error loading products: ${error.message}</div>`;
      } finally {
        listProductsBtn.disabled = false;
        listProductsBtn.textContent = 'Refresh Product List';
      }
    }
    
    // Helper function to get or create a test category
    async function getOrCreateTestCategory() {
      try {
        // Try to find an existing test category
        const { data: existingCategory } = await supabase
          .from('categories')
          .select('id')
          .ilike('name', 'Test Category%')
          .limit(1);
          
        if (existingCategory && existingCategory.length > 0) {
          return existingCategory[0].id;
        }
        
        // If no test category exists, create one
        const { data: newCategory, error } = await supabase
          .from('categories')
          .insert([{ 
            name: 'Test Category ' + Math.random().toString(36).substring(2, 8),
            description: 'Automatically created test category',
            created_at: new Date().toISOString()
          }])
          .select()
          .single();
          
        if (error) throw error;
        return newCategory.id;
        
      } catch (error) {
        console.error('Error in getOrCreateTestCategory:', error);
        // Return a default category ID if we can't create one
        return 'default-category-id';
      }
    }
    
    // Helper function to show results
    function showResult(message, isError) {
      resultDiv.textContent = message;
      resultDiv.className = isError ? 'error' : 'success';
      console.log(isError ? 'Error:' : 'Success:', message);
    }
    
    // Initialize
    loadConfig();
  </script>
</body>
</html>
