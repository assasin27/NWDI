<!DOCTYPE html>
<html>
<head>
  <title>Test Product Creation</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .card { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
    button { 
      background: #4CAF50; 
      color: white; 
      padding: 10px 15px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
      margin: 5px 0;
    }
    button:disabled { background: #cccccc; cursor: not-allowed; }
    #result { 
      margin-top: 15px; 
      padding: 10px; 
      border-radius: 4px; 
      white-space: pre-wrap;
      font-family: monospace;
    }
    .success { background: #dff0d8; color: #3c763d; border: 1px solid #d6e9c6; }
    .error { background: #f2dede; color: #a94442; border: 1px solid #ebccd1; }
    .info { background: #d9edf7; color: #31708f; border: 1px solid #bce8f1; }
  </style>
</head>
<body>
  <h1>Test Product Creation</h1>
  
  <div class="card">
    <h2>Step 1: Sign In</h2>
    <div id="auth-status">Not signed in</div>
    <button id="signIn">Sign In with Email</button>
    <button id="signOut" disabled>Sign Out</button>
  </div>
  
  <div class="card">
    <h2>Step 2: Test Product Creation</h2>
    <p>Create a test product to verify RLS and seller profile integration.</p>
    <button id="testProduct" disabled>Create Test Product</button>
    <div id="testResult"></div>
  </div>
  
  <div class="card">
    <h2>Step 3: Verify Products</h2>
    <p>List all products visible to the current user:</p>
    <button id="listProducts" disabled>List My Products</button>
    <div id="productsList"></div>
  </div>

  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://lzjhjecktllltkizgwnr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6amhqZWNrdGxsbHRraXpnd25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1OTg0NTUsImV4cCI6MjA2ODE3NDQ1NX0.MW3fIJA4X8nnMnC-__8aloqH1tBo4IIpmA_2LPqDxug';
    
    // Initialize Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // DOM Elements
    const authStatus = document.getElementById('auth-status');
    const signInBtn = document.getElementById('signIn');
    const signOutBtn = document.getElementById('signOut');
    const testProductBtn = document.getElementById('testProduct');
    const listProductsBtn = document.getElementById('listProducts');
    const testResult = document.getElementById('testResult');
    const productsList = document.getElementById('productsList');
    
    // Check auth state on load
    async function checkAuth() {
      const { data: { session }, error } = await supabase.auth.getSession();
      console.log('Initial session check:', { session, error });
      updateAuthUI(session);
      return session;
    }
    
    // Set up auth state change listener
    supabase.auth.onAuthStateChange((event, session) => {
      console.log('Auth state changed:', event, session);
      updateAuthUI(session);
    });
    
    // Initial auth check
    checkAuth();
    
    // Sign in with email (prompt)
    signInBtn.addEventListener('click', async () => {
      const email = prompt('Enter your email:');
      if (!email) return;
      
      try {
        showResult(testResult, 'Sending sign-in link to your email...', false);
        
        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: {
            emailRedirectTo: window.location.href,
            shouldCreateUser: true // Allow new users to sign up
          }
        });
        
        if (error) throw error;
        
        showResult(testResult, 'Check your email for the sign-in link! Click it to complete authentication.', false);
        
        // Poll for session after a short delay
        setTimeout(async () => {
          const session = await checkAuth();
          if (session) {
            showResult(testResult, 'Successfully authenticated! You can now create test products.', false);
          }
        }, 2000);
        
      } catch (error) {
        console.error('Sign in error:', error);
        showResult(testResult, `Error signing in: ${error.message}`, true);
      }
    });
    
    // Sign out
    signOutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
    });
    
    // Test product creation
    testProductBtn.addEventListener('click', async () => {
      testProductBtn.disabled = true;
      testProductBtn.textContent = 'Creating test product...';
      
      try {
        // Verify we have a valid session first
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        if (sessionError) throw sessionError;
        if (!session) throw new Error('No active session. Please sign in first.');
        
        console.log('Current session:', session);
        // 1. Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) throw new Error('Not authenticated');
        
        // 2. Get seller profile
        const { data: sellerProfile, error: sellerError } = await supabase
          .from('seller_profiles')
          .select('id')
          .eq('user_id', user.id)
          .single();
          
        if (sellerError || !sellerProfile) {
          throw new Error('Seller profile not found. Please create a seller profile first.');
        }
        
        // 3. Create test product
        const testProduct = {
          name: `Test Product ${new Date().toISOString()}`,
          description: 'This is a test product',
          price: 999, // $9.99 in cents
          category_id: (await getOrCreateTestCategory())[0].id,
          stock_quantity: 10,
          seller_id: sellerProfile.id,
          image_url: 'https://source.unsplash.com/400x300/?product,test',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };
        
        const { data: product, error: productError } = await supabase
          .from('products')
          .insert([testProduct])
          .select()
          .single();
          
        if (productError) throw productError;
        
        showResult(testResult, `✅ Test product created successfully!\nID: ${product.id}\nName: ${product.name}`, false);
        
      } catch (error) {
        console.error('Error creating test product:', error);
        showResult(testResult, `❌ Error: ${error.message}`, true);
      } finally {
        testProductBtn.disabled = false;
        testProductBtn.textContent = 'Create Test Product';
      }
    });
    
    // List products
    listProductsBtn.addEventListener('click', async () => {
      listProductsBtn.disabled = true;
      listProductsBtn.textContent = 'Loading...';
      
      try {
        const { data: products, error } = await supabase
          .from('products')
          .select('*')
          .order('created_at', { ascending: false });
          
        if (error) throw error;
        
        if (products && products.length > 0) {
          productsList.innerHTML = `
            <h3>Your Products (${products.length})</h3>
            <pre>${JSON.stringify(products, null, 2)}</pre>
          `;
        } else {
          productsList.innerHTML = '<p>No products found.</p>';
        }
      } catch (error) {
        productsList.innerHTML = `<div class="error">Error loading products: ${error.message}</div>`;
      } finally {
        listProductsBtn.disabled = false;
        listProductsBtn.textContent = 'List My Products';
      }
    });
    
    // Helper function to get or create a test category
    async function getOrCreateTestCategory() {
      // Try to find an existing test category
      const { data: existingCategory } = await supabase
        .from('categories')
        .select('*')
        .ilike('name', 'Test Category%')
        .limit(1);
        
      if (existingCategory && existingCategory.length > 0) {
        return existingCategory;
      }
      
      // If no test category exists, create one
      const { data: newCategory, error } = await supabase
        .from('categories')
        .insert([{ 
          name: 'Test Category ' + Math.random().toString(36).substring(2, 8),
          description: 'Automatically created test category',
          created_at: new Date().toISOString()
        }])
        .select();
        
      if (error) throw error;
      return newCategory;
    }
    
    // Update UI based on auth state
    function updateAuthUI(session) {
      if (session) {
        const user = session.user;
        authStatus.innerHTML = `
          <div class="success">
            Signed in as: <strong>${user.email}</strong><br>
            User ID: <code>${user.id}</code>
          </div>
        `;
        signInBtn.disabled = true;
        signOutBtn.disabled = false;
        testProductBtn.disabled = false;
        listProductsBtn.disabled = false;
      } else {
        authStatus.innerHTML = '<div class="info">Not signed in</div>';
        signInBtn.disabled = false;
        signOutBtn.disabled = true;
        testProductBtn.disabled = true;
        listProductsBtn.disabled = true;
        productsList.innerHTML = '';
      }
    }
    
    // Helper function to show results
    function showResult(element, message, isError) {
      element.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
      element.scrollIntoView({ behavior: 'smooth' });
    }
  </script>
</body>
</html>
